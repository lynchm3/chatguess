<!DOCTYPE html>
<html>

<head>
  <title>ChatGuessGames</title>
  <link rel="stylesheet" href="memes.css">
  <link rel="stylesheet" href="infinity-mirror.css">
  <script src="/utils.js"></script>
</head>

<body>

  <div class="div-gifs" id="div-gifs"></div>

  <div id="box"></div><!-- Display the countdown timer in an element -->

  <!-- <input class="guessBox" type="text" placeholder="Guess?" onkeydown="search(this)"/> -->

  <!-- socket.io -->
  <script src="/socket.io/socket.io.js"></script>

  <script>

    var socket = io();
    const gameImages = []

    const canvas = document.createElement("canvas");
    document.body.appendChild(canvas);
    const ctx = canvas.getContext("2d");

    const draw = (body, ctx) => {
      ctx.beginPath();
      body.forEach(e => ctx.lineTo(e.x, e.y));
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
    };

    socket.once("connect", () => {
      socket.emit("register", res => {
        canvas.width = res.canvas.width;
        canvas.height = res.canvas.height;
      });
    });

    socket.on("update state", ({ boxes, walls }) => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#fff";
      ctx.strokeStyle = "#fff";
      walls.forEach(wall => draw(wall, ctx));
      // ctx.fillStyle = "#fff";
      // boxes.forEach(box => draw(box, ctx));

      boxes.forEach(function (box, i) {
        console.log("boxes.forEach");
        var img = new Image();
        console.log('img');
        console.log(img);
        console.log('i');
        console.log(i);
        console.log('gameImages[i]');
        console.log(gameImages[i]);
        img.src = gameImages[i].url;
        img.onload = function (e) {
          ctx.drawImage(img, box[0].x, box[0].y, box[1].x-box[0].x, box[3].y - box[0].y);
        }
      });
    });

    // function loadImage(path) {
    //   var img = new Image();
    //   img.onload = drawImage;
    //   img.src = path;
    // }

    // function drawImage(event) {
    //   var img = event.target;
    //   var imgSize = Math.min(img.width, img.height);
    //   // The following two lines yield a central based cropping.
    //   // They can both be amended to be 0, if you wish it to be
    //   // a left based cropped image.
    //   var left = (img.width - imgSize) / 2;
    //   var top = (img.height - imgSize) / 2;
    //   //var left = 0; // If you wish left based cropping instead.
    //   //var top = 0; // If you wish left based cropping instead.
    //   ctx.drawImage(event.target, left, top, imgSize, imgSize, 0, 0, ctx.canvas.width, ctx.canvas.height);
    // }

    document.addEventListener("mousedown", e => {
      socket.emit("player click", { x: e.offsetX, y: e.offsetY });
    });


    function search(element) {
      if (event.key === 'Enter') {
        socket.emit('guess', "" + element.value);
        alert(element.value);
      }
    }

    //Text
    socket.on('showText', function (text) {
      showText(text)
    })

    function showText(text) {
      const box = document.getElementById('box');
      var container = document.createElement("div")
      container.classList.add('hint');
      const textNode = document.createTextNode(`\n\n${text}`);
      container.appendChild(textNode);
      box.appendChild(container);
    }

    function randomIntFromInterval(min, max) {
      return Math.floor(Math.random() * (max - min + 1) + min)
    }

    var div_gifs = document.getElementById('div-gifs');

    // clear images
    socket.on('clearImages', function () {
      div_gifs.innerHTML = "";
    });

    // show title
    socket.on('showTitle', function () {

      //background
      var gameBackground3 = document.createElement("div")
      gameBackground3.classList.add('gameBackground');
      div_gifs.appendChild(gameBackground3);

      //title
      var container = document.createElement("div")
      container.classList.add('title');
      var img = document.createElement("img");
      img.src = "whats_the_game_title.png";
      container.appendChild(img);
      div_gifs.appendChild(container);

      //audio cue
      const audio = new Audio("chatguessgames.mp3");
      audio.play();
    });

    // clear images
    socket.on('showCoverImage', function (gameImage, username) {

      var container = document.createElement("div")
      container.style.opacity = 0;
      container.classList.add('coverArt');
      var img = document.createElement("img");
      img.src = gameImage.url;
      container.appendChild(img);
      div_gifs.appendChild(container);

      img.onload = function () {

        var naturalWidth = img.naturalWidth;
        var naturalHeight = img.naturalHeight;

        let screenWidth = window.innerWidth;
        let screenHeight = window.innerHeight;
        let maxCoverHeight = screenHeight * 0.8

        //Container Height
        let containerHeight = maxCoverHeight
        if (containerHeight > naturalHeight)
          containerHeight = naturalHeight
        container.style.height = containerHeight + "px"
        img.style.height = containerHeight + "px"

        //Container Width
        let containerWidth = containerHeight / naturalHeight * naturalWidth
        if (containerWidth > naturalWidth)
          containerWidth = naturalWidth
        container.style.width = containerWidth + "px"
        img.style.width = containerWidth + "px"

        //Container position
        var x = (screenWidth - containerWidth) / 2
        var y = (screenHeight - containerHeight) / 2 - 16
        container.style.left = x + 'px';
        container.style.top = y + 'px';

        var speed = 0.05
        fadeIn(container, speed)

        var textContainer = document.createElement("div")
        textContainer.classList.add('winner');
        textContainer.style.left = `${x}px`
        textContainer.style.top = `${y + 350}px`
        const textNode = document.createTextNode(`${username} got it!`);
        textContainer.appendChild(textNode);
        div_gifs.appendChild(textContainer);



        setTimeout(function () {
          div_gifs.innerHTML = "";
        }, 10_000);
      }
    });

    //showImage  
    socket.on('showImage', function (gameImage, maxWidth) {

      gameImages.push(gameImage)

      // console.log("memes.html showImage gameImage = ")
      // console.log(gameImage)
      var container = document.createElement("div")
      // container.style.visibility='hidden'
      container.style.opacity = 0;
      container.classList.add('crop');
      // console.log("memes.html showImage container = " + container)
      var img = document.createElement("img");
      img.src = gameImage.url;
      // console.log("memes.html showImage img = " + img)

      container.appendChild(img);
      div_gifs.appendChild(container);

      img.onload = function () {

        var naturalWidth = img.naturalWidth;
        var naturalHeight = img.naturalHeight;

        let screenWidth = window.innerWidth;
        let screenHeight = window.innerHeight;
        console.log("screenWidth")
        console.log(screenWidth)

        //Container Height
        let croppedWidth = maxWidth
        if (croppedWidth > naturalWidth)
          croppedWidth = naturalWidth
        container.style.width = croppedWidth + "px"

        //Container Width
        let croppedHeight = croppedWidth / naturalWidth * naturalHeight
        if (croppedHeight > naturalHeight)
          croppedHeight = naturalHeight
        container.style.height = croppedHeight + "px"

        //Container position
        var x = 0
        var y = 0
        const maxAttempts = 10
        var attempts = 0
        while ((x < 320 && y < 210) || (x + croppedWidth > 1000 && y + croppedHeight > 520)) {
          var x = 70 + Math.floor(Math.random() * (screenWidth - 140 - container.offsetWidth))
          var y = 70 + Math.floor(Math.random() * (screenHeight - 140 - container.offsetHeight))
          attempts++
          if (attempts > maxAttempts)
            break
        }

        container.style.left = x + 'px';
        container.style.top = y + 'px';

        var totalHorizontalMargin = croppedWidth - naturalWidth;
        var imgMarginLeft = totalHorizontalMargin / 2
        var imgMarginRight = imgMarginLeft
        if (imgMarginLeft < -100) {
          imgMarginLeft = randomIntFromInterval((totalHorizontalMargin) + 100, -100)
          imgMarginRight = totalHorizontalMargin - imgMarginLeft
        }

        var totalVerticalMargin = croppedHeight - naturalHeight;
        var imgMarginTop = totalVerticalMargin / 2
        var imgMarginBottom = imgMarginTop
        if (imgMarginTop < -100) {
          imgMarginTop = randomIntFromInterval((totalVerticalMargin) + 100, -100)
          imgMarginBottom = totalVerticalMargin - imgMarginTop
        }

        // console.log("croppedWidth: " + croppedWidth)
        // console.log("naturalWidth: " + naturalWidth)
        // console.log("croppedHeight: " + croppedHeight)
        // console.log("naturalHeight: " + naturalHeight)

        img.style.marginLeft = `${imgMarginLeft}px`
        img.style.marginRight = `${imgMarginRight}px`
        img.style.marginTop = `${imgMarginTop}px`
        img.style.marginBottom = `${imgMarginBottom}px`

        // console.log("imgMarginLeft: " + imgMarginLeft)
        // console.log("imgMarginRight: " + imgMarginRight)
        // console.log("imgMarginTop: " + imgMarginTop)
        // console.log("imgMarginBottom: " + imgMarginBottom)

        var speedIn = 0.05
        fadeIn(container, speedIn)
      }
    });
    // End showImage


    //playVideo
    socket.on('playVideo', function (src) {
      playSmallVideo(src)
    })

    function playSmallVideo(src) {

      var container = document.createElement("div")
      container.classList.add('div-gif-holder');

      var video = document.createElement("video")
      video.classList.add('div-gif');
      // video.style.height = "160px"
      video.style.width = "284px"
      video.style.opacity = 1
      container.appendChild(video);
      container.style.opacity = 1
      // container.style.height = "160px"
      container.style.width = "284px"

      // video.onload = function () {
      var width = 800//container.offsetWidth
      var height = 500//container.offsetHeight      

      let screenWidth = window.innerWidth;
      let screenHeight = window.innerHeight;

      var x = Math.floor(Math.random() * (screenWidth - width))
      var y = Math.floor(Math.random() * (screenHeight - height))

      container.style.left = x + 'px';
      container.style.top = y + 'px';

      div_gifs.appendChild(container);
      // }

      video.onended = function () { container.remove() }

      video.src = src
      video.autoplay = true
      // video.load()
      // video.play()
    }


    // playAudio
    socket.on('playAudio', function (src) {
      // console.log("memes.html playAudio - " + src)
      playAudio(src)
    });

    function playAudio(src) {
      var audio = new Audio(src)
      audio.addEventListener('canplaythrough', (event) => {
        audio.play()
      });
    }
    // End playAudio


    //VIDEO

    // var videoContainer = document.getElementById("video");
    // var video = document.getElementById("videoID");

    // video.onended = function () {
    //   videoContainer.style.display = "none"
    // };

    socket.on('showVideo', function (video) {
      // console.log("video.html showVideo() video = " + video)
      PlayVideo(video)
      return;
    });

    function StopVideo() {
      document.getElementById('videoID').pause();
    }
    //END VIDEO

  </script>
  <!-- End socket.io -->
</body>

</html>